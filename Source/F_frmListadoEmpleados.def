CodeBehindForm
Attribute VB_GlobalNameSpace = False
Attribute VB_Creatable = True
Attribute VB_PredeclaredId = True
Attribute VB_Exposed = False


Option Compare Database
Option Explicit
Dim gintActualizarFacturacionRecibidaDetalleXGruposAux As Integer
Dim gintActualizarRegistroComprasAux As Integer

Private Sub btnAceptar_Click()
    Dim strSQL As String
    Dim strTitulo As String
    Dim intRes As Integer
    Dim rs As Recordset, rsSelect As Recordset
    Dim i As Integer
    Dim strW As String, strXML As String
    On Error GoTo Error_btnAceptar_Click
'    If Me.cmbEmpresa.ListIndex = -1 Then
'        MsgBox "Se debe seleccionar empresa"
'        Me.cmbEmpresa.SetFocus
'        Exit Sub
'    End If
    DoCmd.Hourglass True
    strTitulo = Me.lblTitulo.Caption
    strSQL = "SELECT tbEmpl_Presencia.IdEmpl, tbEmpl.CodEmpl, Trim([Nombre] & ' ' & [Apellidos]) AS Empleada_o, tbEmpl_Presencia.Fecha, tbEmpl_Presencia.HoraIni, tbEmpl_Presencia.HoraFin, [HoraFin]-[HoraIni] AS Trabajado, ([HoraFin]-[HoraIni])*24 AS [Trabajado horas]"
    strSQL = strSQL & " FROM tbEmpl INNER JOIN tbEmpl_Presencia ON tbEmpl.IdEmpl = tbEmpl_Presencia.IdEmpl"
    strSQL = strSQL & " WHERE Fecha >= " & CLng(CDate(Me.txtDesde)) & " And Fecha <= " & CLng(CDate(Me.txtHasta))
    If Me.cmbEmpleados <> 0 Then strSQL = strSQL & " AND tbEmpl_Presencia.IdEmpl = " & Me.cmbEmpleados
    CurrentDb.QueryDefs("qryEmpl_Pre").SQL = strSQL
Presentar:
    PonXML strXML, "Subtitulo", Me.lblTitulo.Caption
    If Me.mrcPantImp = 1 Then
        DoCmd.OpenReport "rptEmpl_Presencia", acViewPreview, , , , strXML
    Else
        DoCmd.OpenReport "rptEmpl_Presencia", , , , , strXML
    End If
Exit_btnAceptar_click:
    DoCmd.Hourglass False
    Close
    Exit Sub
Error_btnAceptar_Click:
    Select Case Err
        Case 2501
            Resume Exit_btnAceptar_click
        Case Else
            MsgBox Err.Description
            Resume Exit_btnAceptar_click
    End Select
        
End Sub


Private Sub btnCancelar_Click()
    On Error Resume Next
    DoCmd.Close
End Sub


Private Sub cmbEmpresa_AfterUpdate()
    Call mrcTDiDe_AfterUpdate
End Sub

Private Sub cmbMes_AfterUpdate()
    Me.txtDesde = CDate(Me.txtAño & "/" & Me.cmbMes & "/" & "01")
    Me.txtHasta = CDate(Me.txtAño & "/" & Me.cmbMes & "/" & CStr(DiasDelMes(CInt(Me.cmbMes), CInt(Me.txtAño))))
    Call mrcTDiDe_AfterUpdate
End Sub


Private Sub Form_Activate()
    DoCmd.Maximize
End Sub

Private Sub Form_Load()
    MascaraFechasForm Me
    Call mrcTDiDe_AfterUpdate
End Sub

Private Sub mrcTDiDe_AfterUpdate()
    Dim strTitulo As String
    Dim strSQL As String
    Dim strTit As String
    If Me.cmbEmpleados <> 0 Then
        strTitulo = "Empleada/o: " & Me.cmbEmpleados.Column(2) & ". "
        strTit = "Empleada/o: " & Me.cmbEmpleados.Column(2) & ". "
    End If
    If Me.mrcTREF = 1 Then
        If Me.mrcTrimestre = 6 Then
            strTitulo = strTitulo & "Mes: " & Me.cmbMes.Column(1) & " " & Me.txtAño
            strTit = strTit & "Mes: " & Me.cmbMes.Column(1) & " " & Me.txtAño
        ElseIf Me.mrcTrimestre = 5 Then
            strTitulo = strTitulo & "Año: " & Me.txtAño
            strTit = strTit & "Año: " & Me.txtAño
        Else
            strTitulo = strTitulo & "Trimestre: " & Me.mrcTrimestre & " / " & Me.txtAño
            strTit = strTit & "Trimestre: " & Me.mrcTrimestre & " / " & Me.txtAño
        End If
    Else
        strTitulo = strTitulo & "Desde el " & Me.txtDesde & " hasta el " & Me.txtHasta
        strTit = strTit & "Desde el " & Me.txtDesde & " hasta el " & Me.txtHasta
    End If
'    strTitulo = strTitulo & vbCrLf & "Empresa: " & Me.cmbEmpresa.Column(1)
'    strTit = strTit & vbCrLf & "Empresa: " & Me.cmbEmpresa.Column(1)
    Me.lblTitulo.Caption = strTitulo
End Sub

Private Sub mrcTREF_Click()
    Dim ctl As Control
    Dim intTRver As Integer
    Call mrcTrimestre_AfterUpdate
    If Me.mrcTREF = 1 Then
        intTRver = True
    Else
        intTRver = False
    End If
    For Each ctl In Me.Controls
        If InStr(ctl.Tag, "TR") > 0 Then ctl.Visible = intTRver
        If InStr(ctl.Tag, "EF") > 0 Then ctl.Visible = Not intTRver
        'Select Case ctl.Tag
        '    Case ""
        '    Case "TR"
        '        ctl.Visible = intTRver
        '    Case "EF"
        '        ctl.Visible = Not intTRver
        'End Select
    Next ctl
End Sub

Private Sub mrcTrimestre_AfterUpdate()
    gintActualizarRegistroComprasAux = True
    gintActualizarFacturacionRecibidaDetalleXGruposAux = True
    Select Case mrcTrimestre.value
        Case 1
            Me.txtDesde = CDate(Me.txtAño & "/01/01")
            Me.txtHasta = CDate(Me.txtAño & "/03/31")
        Case 2
            Me.txtDesde = CDate(Me.txtAño & "/04/01")
            Me.txtHasta = CDate(Me.txtAño & "/06/30")
        Case 3
            Me.txtDesde = CDate(Me.txtAño & "/07/01")
            Me.txtHasta = CDate(Me.txtAño & "/09/30")
        Case 4
            Me.txtDesde = CDate(Me.txtAño & "/10/01")
            Me.txtHasta = CDate(Me.txtAño & "/12/31")
        Case 5
            Me.txtDesde = CDate(Me.txtAño & "/01/01")
            Me.txtHasta = CDate(Me.txtAño & "/12/31")
        Case 6
            Me.cmbMes = Format(Month(Date), "00")
            Call cmbMes_AfterUpdate
    End Select
    If Me.mrcTrimestre = 6 Then
        Me.cmbMes.Visible = True
    Else
        Me.cmbMes.Visible = False
    End If
    Call mrcTDiDe_AfterUpdate
End Sub

Private Sub txtAño_AfterUpdate()
    Call mrcTrimestre_AfterUpdate
    Call mrcTDiDe_AfterUpdate
End Sub


Private Sub txtDesde_AfterUpdate()
    Call mrcTDiDe_AfterUpdate
End Sub

Private Sub txtHasta_AfterUpdate()
    Call mrcTDiDe_AfterUpdate
End Sub
